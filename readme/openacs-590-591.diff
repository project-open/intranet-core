

=======================================================
acs-admin/www/auth/
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/auth/authority.adp openacs-4.5-9-0/packages/acs-admin/www/auth/authority.adp
24,36d23
< <if @import_users_url@ not nil>
<   <p>
<     <b>&raquo;</b> <a href="@import_users_url@">Batch-import users for this authority</a>
<   </p>
< </if>
< 
< <if @import_groups_url@ not nil>
<   <p>
<     <b>&raquo;</b> <a href="@import_groups_url@">Batch-import groups for this authority</a>
<   </p>
< </if>
< 
< 

diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/auth/authority.tcl openacs-4.5-9-0/packages/acs-admin/www/auth/authority.tcl
325,330d324
< 
< 
< set import_users_url [export_vars -base "/auth-ldap-adldapsearch/import-users"]
< 
< 
< 


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/auth/index.adp openacs-4.5-9-0/packages/acs-admin/www/auth/index.adp
4,6d3
< <property name="main_navbar_label">admin</property>
< <property name="title">@page_title;literal@</property>
< <property name="left_navbar">@left_navbar_html;literal@</property>


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/auth/index.tcl openacs-4.5-9-0/packages/acs-admin/www/auth/index.tcl
147,167d146
< # ----------------------------------------------------------
< # Left Navbar
< # ----------------------------------------------------------
< 
< set ldap_wizard_l10n [lang::message::lookup "" intranet-sysconfig.LDAP_Configuration_Wizard "LDAP Configuration Wizard"]
< set admin_html "
< <ul>
< <li><a href=/intranet-sysconfig/ldap/index>$ldap_wizard_l10n</a>
< </ul>
< "
< 
< set left_navbar_html "
<         <div class='filter-block'>
<         <div class='filter-title'>
<             [lang::message::lookup "" intranet-core.Admin_LDAP_Authorities "Admin LDAP Authorities"]
<         </div>
<         $admin_html
<         </div>
<         <hr>
< "
< 











=======================================================
=======================================================





diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/install/index.tcl openacs-4.5-9-0/packages/acs-admin/www/install/index.tcl
21,24d20
< 
< 
< 
< ad_returnredirect "/acs-admin/apm/packages-install"



=======================================================
server-restart
=======================================================


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/server-restart.adp openacs-4.5-9-0/packages/acs-admin/www/server-restart.adp
0a1
> <master>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-admin/www/server-restart.tcl openacs-4.5-9-0/packages/acs-admin/www/server-restart.tcl
17,26d16
< global tcl_platform
< set platform $tcl_platform(platform)
< switch $platform {
<     "windows" {
<         # Restart doesn't work on Windows services, so handle it here...
<         ad_schedule_proc -thread t -once t 2 ns_shutdown -restart
<     }
<     default {
<         # Don't modify default behavior.
<         # Trust Linux to handle restarts
28,29d17
<     }
< }




=======================================================
api-browser
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-api-browser/www/package-view.adp openacs-4.5-9-0/packages/acs-api-browser/www/package-view.adp
1d0
< <if @show_master_p@>
3,7c2,4
< <property name=title>@title;noquote@</property>
< <property name="context">@context;noquote@</property>
< </if>
< 
< <property name="header">
---
> <property name="doc(title)">@title;literal@</property>
> <property name="context">@context;literal@</property>
> <property name="head">
9,11c6
<        td.wide {
<        	       width:35%;
<        }
---
> td.wide {width:35%;}
13a9
> @dimensional_slider;noquote@
15,26c11
< <if "" ne @error_message@>
< <!-- <font color=red> -->
< @error_message@
< <!-- </font> -->
< </if>
< 
< <if "" ne @version_id@>
< 
< <!-- @dimensional_slider;noquote@ --> 
< 
< <h2>Procedure Files</h2>
< <if @procs_files_p@>
---
> <if @kind@ eq "procs_files">
39,41c24
< 
< <if @procs_p@>
< <h2>Procedures</h2>
---
> <if @kind@ eq "procs">
54,56c37
< 
< <if @sql_files_p@>
< <h2>SQL Files</h2>
---
> <if @kind@ eq "sql_files">
69,71c50
< 
< <if @content_p@>
< <h2>Content Pages</h2>
---
> <if @kind@ eq "content">
76,77c55,56
<       <td style="width:35%">@content_pages.indentation;noquote@
<        <b><a href="https://www.project-open.net/api-doc/content-page-view?version_id=@version_id@&amp;path=@content_pages.full_path@">@content_pages.name@</a></b>
---
>       <td class="wide">@content_pages.indentation;noquote@
>        <b><a href="content-page-view?version_id=@version_id@&amp;path=@content_pages.full_path@">@content_pages.name@</a></b>
79c58
<          <a href="https://www.project-open.net/api-doc/type-view?type=@content_pages.type@"></a>
---
>          <a href="type-view?type=@content_pages.type@"></a>
91,92d69
< 
< </if>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-api-browser/www/package-view.tcl openacs-4.5-9-0/packages/acs-api-browser/www/package-view.tcl
1d0
< if {![info exists package_key]} {
13c12
<         { version_id "" }
---
>     version_id:naturalnum,notnull
29,47d27
< } else {
<     set kind "all"
<     set public_p ""
<     set about_package_key ""
< }
< 
< set error_message ""
< set dimensional_slider ""
< if {![info exists show_master_p]} { set show_master_p 1 }
< 
< if {![info exists version_id] || "" == $version_id} {
<     if {[info exists package_key] && "" != $package_key} {
<         set version_id [db_string package_version "select min(version_id) from apm_package_versions where package_key = :package_key" -default ""]
<     }
< }
< 
< if {"" == $version_id} { set error_message "Package '$package_key' is not installed on this server, so there is no documentation available." }
< if {"all" == $kind} { set kind "procs_files procs sql_files content" }
< set url "/api-doc"
79a60
> 
82,83d62
< 
< # One of the vars is not 
89,97c68
< set procs_p 0
< set procs_files_p 0
< set sql_files_p 0
< set content_p 0
< set abs_path "https://www.project-open.net/api-doc/"
< 
< 
< foreach k $kind {
< switch $k {
---
> switch $kind {
99d69
<         set procs_files_p 1
110c80
<                 set view ${abs_path}procs-file-view
---
>                 set view procs-file-view
118c88
<                 set view ${abs_path}content-page-view
---
>                 set view content-page-view
125d94
<         set procs_p 1
149d117
<         set sql_files_p 1
162d129
<         set content_p 1
211d177
< }




=======================================================
authentication-procs.tcl
=======================================================


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-authentication/tcl/authentication-procs.tcl openacs-4.5-9-0/packages/acs-authentication/tcl/authentication-procs.tcl
224,232d223
< 
<         # Check for email instead of username
<         set user_id_from_email [db_string email_p "select min(party_id) from parties where lower(email) = lower(trim(:username))" -default ""]
<         if {"" ne $user_id_from_email} {
<             ns_log Notice "auth::authenticate: found that username='$username' is actually a valid email for user_id=$user_id_from_email"
<             set username [db_string uname "select username from users where user_id = :user_id_from_email"]
<             ns_log Notice "auth::authenticate: New username='$username' for user_id=$user_id_from_email"
<         }
< 



=======================================================
bootstrap
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-bootstrap-installer/bootstrap.tcl openacs-4.5-9-0/packages/acs-bootstrap-installer/bootstrap.tcl
147c147
< #    apm_bootstrap_load_libraries -procs acs-automated-testing
---
>     apm_bootstrap_load_libraries -procs acs-automated-testing





diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-content-repository/sql/postgresql/upgrade/upgrade-5.9.0d1-5.9.0d2.sql openacs-4.5-9-0/packages/acs-content-repository/sql/postgresql/upgrade/upgrade-5.9.0d1-5.9.0d2.sql

22,27c22
< 
< -- fraber 161128: Delete inconsistent entries
< update cr_items set latest_revision = null 
< where latest_revision in (select latest_revision from cr_items except select revision_id from cr_revisions);
31,35c26
< -- fraber 161128: Delete inconsistent entries
< update cr_items set live_revision = null 
< where live_revision in (select live_revision from cr_items except select revision_id from cr_revisions);



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-developer-support/tcl/acs-developer-support-procs.tcl openacs-4.5-9-0/packages/acs-developer-support/tcl/acs-developer-support-procs.tcl
208c208
< 		 <a href="$ds_url/request-info?request=$::ad_conn(request)">Request Information</a><br>
---
> 		 <a href="$ds_urlrequest-info?request=$::ad_conn(request)">Request Information</a><br>







=======================================================
translation server
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/lib/messages-to-translate.tcl openacs-4.5-9-0/packages/acs-lang/lib/messages-to-translate.tcl
14,16d13
<             display_template {
<                  <a href="@messages.translate_orig_url@" target="_blank">@messages.orig_text@</a>
<             }
22c19
<                  <a href="@messages.translate_url@" title="Translate" target="_blank"><font color="red">Translate</font></a>
---
>                  <a href="@messages.translate_url@" title="Translate"><font color="red">Translate</font></a>
43c40
<     multirow create messages message_key orig_text translated_text translate_url translated_p translate_orig_url
---
>     multirow create messages message_key orig_text translated_text translate_url translated_p
62,67d58
<         set translate_orig_url [export_vars -base /acs-lang/admin/edit-localized-message {
< 	    {message_key $message_key_part}
< 	    {package_key $package_key_part}
< 	    {locale en_US}
< 	    {return_url [ad_return_url]}
< 	}]
71c62
<         multirow append messages $message_key $orig_text $translated_text $translate_url $translated_p $translate_orig_url
---
>         multirow append messages $message_key $orig_text $translated_text $translate_url $translated_p




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/tcl/lang-util-procs.xql openacs-4.5-9-0/packages/acs-lang/tcl/lang-util-procs.xql
16,22c16
< 	select	min(locale)
< 	from	ad_locales
< 	where	language = '[db_quote $language]' and
< 		enabled_p = 't' and 
< 		(
< 			default_p = 't'
< 		OR	(select	count(*)
---
>         select locale
25c19,23
< 			) = 1
---
>         and    enabled_p = 't'
>         and    (default_p = 't' or
>                 (select count(*)
>                 from ad_locales
>                 where language = '[db_quote $language]') = 1




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/www/admin/edit-localized-message.tcl openacs-4.5-9-0/packages/acs-lang/www/admin/edit-localized-message.tcl
18d17
<     {submit_remote_p "1" }
51,54d49
< set delete_url [export_vars -base message-delete { locale package_key message_key show {return_url {[ad_return_url]}} }]
< 
< 
< set submit_remote_options_list [list [list "Submit to translation server" 1]]
56,57c51
< 
< # element create message_new submit_remote_p -optional -label "" -datatype text -widget checkbox -options $submit_remote_options_list
---
> set delete_url [export_vars -base message-delete { locale package_key message_key show {return_url {[ad_return_url]}} }]
66,67c60,68
<     {message_key_pretty:text(inform) {label "Message Key"} {value "$package_key.$message_key"}}
<     {description:text(inform) {label "Description"} {after_html {}}}
---
> 
>     {message_key_pretty:text(inform)
>         {label "Message Key"}
>         {value "$package_key.$message_key"}
>     }
>     {description:text(inform)
>         {label "Description"}
>         {after_html {}}
>     }
79,82c80,90
<     {message:text(textarea) {label "$locale_label Message"} {html { rows 6 cols 60 }}}
<     {comment:text(textarea),optional {label "Comment"} {html { rows 6 cols 60 }}}
<     {submit_remote_p:text(checkbox),optional {label ""} {options $submit_remote_options_list}}
<     {submit:text(submit) {label "     Update     "}}
---
>     {message:text(textarea)
>         {label "$locale_label Message"} 
>         {html { rows 6 cols 40 } }
>     }
>     {comment:text(textarea),optional
>         {label "Comment"}
>         {html { rows 6 cols 40 }}
>     }
>     {submit:text(submit)
>         {label "     Update     "}
>     }
142,143c150,151
<                from   lang_messages_audit lma
<                       LEFT OUTER JOIN cc_users cu ON (cu.user_id = lma.overwrite_user)
---
>                from lang_messages_audit lma,
>                     cc_users cu
146a155
>                and    cu.user_id = lma.overwrite_user
178,182d186
< 
<     # Register on translation server
<     if {1 eq $submit_remote_p} {
<         lang::message::register_remote $locale $package_key $message_key $message
<     }




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/www/admin/localized-message-new.tcl openacs-4.5-9-0/packages/acs-lang/www/admin/localized-message-new.tcl
16d15
<     {submit_remote_p "1" }
20,21d18
< set focus ""
< 
26,27c23,24
< set locale_label [ad_locale_get_label $current_locale]
< set default_locale_label [ad_locale_get_label $default_locale]
---
> set locale_label [lang::util::get_label $current_locale]
> set default_locale_label [lang::util::get_label $default_locale]
30,31c27,28
< set context [list [list "package-list?[export_vars { locale }]" $locale_label] \
<                  [list "message-list?[export_vars { locale package_key show }]" $package_key] \
---
> set context [list [list [export_vars -base package-list { locale }] $locale_label] \
>                  [list [export_vars -base message-list { locale package_key show }] $package_key] \
41c38
< if { ![string equal $current_locale $default_locale] } {
---
> if { $current_locale ne $default_locale } {
64,68d60
< set submit_remote_options_list [list [list "Submit to translation server" 1]]
< element create message_new submit_remote_p -optional -label "" -datatype text \
<     -widget checkbox -options $submit_remote_options_list
<  
< 
75,76c67
<     element set_value message_new submit_remote_p $submit_remote_p
<     if { [empty_string_p $message_key] } {
---
>     if { $message_key eq "" } {
117,121d107
<     # Register on translation server
<     if {1 eq $submit_remote_p} {
<         lang::message::register_remote $locale $package_key $message_key $message
<     }
< 
126a113,121
> 
> set focus ""
> 
> ad_return_template
> # Local variables:
> #    mode: tcl
> #    tcl-indent-level: 4
> #    indent-tabs-mode: nil
> # End:




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/www/admin/message-list.adp openacs-4.5-9-0/packages/acs-lang/www/admin/message-list.adp
63,65d62
<                 <nobr>@messages.package_key@</nobr>
<               </td>
<               <td>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/www/admin/message-list-postgresql.xql openacs-4.5-9-0/packages/acs-lang/www/admin/message-list-postgresql.xql
10d9
<            lm1.package_key,
19c18
<     and    lm1.package_key $package_key_sql
---
>     and    lm1.package_key = :package_key




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-lang/www/admin/message-list.tcl openacs-4.5-9-0/packages/acs-lang/www/admin/message-list.tcl
11c11
<     { package_key ""}
---
>     package_key
51,57c51,66
< set package_key_sql " = :package_key"
< if {"" eq $package_key} { set package_key_sql " in (select package_key from apm_packages)" }
< 
< db_1row counts "
<     select (select count(*) from lang_messages where package_key $package_key_sql and locale = :locale and deleted_p = 'f') as num_translated,
<            (select count(*) from lang_messages where package_key $package_key_sql and locale = :default_locale and deleted_p = 'f') as num_messages,
<            (select count(*) from lang_messages where package_key $package_key_sql and locale = :default_locale and deleted_p = 't') as num_deleted
---
> db_1row counts {
>     select (select count(*) 
>             from lang_messages 
>             where package_key = :package_key 
>             and locale = :locale
>             and deleted_p = 'f') as num_translated,
>            (select count(*) 
>             from lang_messages 
>             where package_key = :package_key 
>             and locale = :default_locale 
>             and deleted_p = 'f') as num_messages,
>             (select count(*) 
>              from lang_messages 
>              where package_key = :package_key 
>              and locale = :default_locale 
>              and deleted_p = 't') as num_deleted
59c68
< "
---
> }




=======================================================
mail-lite
=======================================================




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-mail-lite/tcl/acs-mail-lite-procs.tcl openacs-4.5-9-0/packages/acs-mail-lite/tcl/acs-mail-lite-procs.tcl
424a425
>         
594,599d594
<         
<         # fraber 2016-11-02: Overwrite fixed_sender in case we got
<         # issues with corporate mail gateways etc.
<         if { $fixed_sender ne ""} {
<             set originator $fixed_sender
<         }



=======================================================
login
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-subsite/lib/login.adp openacs-4.5-9-0/packages/acs-subsite/lib/login.adp
6,8d5
<         <table cellspacing=0 cellpadding=0 border=0>
<         <tr valign=center>
<         <td>
14a12
> 
15a14
> 
19,40d17
< 		</if>
<         </td>
< 	<td width=10>&nbsp;</td>
<         <td align=right>
<                 <table>
<                   <tr><td align=center>Powered by</td></tr>
<                   <tr>
<                     <td align=center>
<                       <a href="https://www.project-open.com/">
<                         <img
<                           src="/intranet/images/project_open.70x26.gif"
<                           alt="Open Source Enterprise Project Management"
<                           title="Open Source Enterprise Project Management"
<                           border=0
<                         >
<                       </a>
<                     </td>
<                   </tr>
<                 </table>
<         </td>
<         </tr>
<         </table>
41a19
> </if>
43,44d20
< 
< 




=======================================================
calendar JS
=======================================================


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-subsite/www/resources/core.js openacs-4.5-9-0/packages/acs-subsite/www/resources/core.js
1716,1720d1715
< 
<     if (!idM.value) idM.value = new Date().getMonth();
<     if (!idD.value) idD.value = new Date().getDate();
<     if (!idY.value) idY.value = new Date().getFullYear();
< 
1778,1784d1772
< 
<       // Trigger the "change" event of the date 
<       var event = new Event('change');
<       cal.selM.dispatchEvent(event);
<       cal.selY.dispatchEvent(event);
<       cal.selD.dispatchEvent(event);
< 




=======================================================
]po[ custom page-error
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/lib/page-error.adp openacs-4.5-9-0/packages/acs-tcl/lib/page-error.adp
1,23d0
< <%
< # Write out HTTP headers
< set header_vars [ns_conn headers]
< set electron_agent_p 0
< foreach var [ad_ns_set_keys $header_vars] {
<     set value [ns_set get $header_vars $var]
<     ns_log Notice "page-error: header: $var: $value"
< 
<     if {"User-Agent" eq $var} {
< 	if {[regexp {Electron/2} $value match]} { set electron_agent_p 1 }
<     }
< }
< %>
< 
< <if 1 eq @electron_agent_p@>
< 
< <if @top_message@ not nil>@top_message;noquote@</if>
< <if @message@ not nil    >@message;noquote@</if>
< <if @stacktrace@ not nil >@stacktrace;noquote@</if>
< 
< </if>
< <else>
< <!-- This page goes into /packages/apm-tcl/lib/page-error.adp -->
26,27d2
< 
< 
29,32d3
< <if @top_message@ not nil>
< 	@top_message;noquote@
< </if>
< <else>
34d4
< </else>
36,95d5
< 
< <% set error_url [im_url_with_query] %>
< <% set error_location "[ns_info address] on $::tcl_platform(platform)" %>
< <% set report_url [parameter::get -package_id [im_package_core_id] -parameter "ErrorReportURL" -default ""] %>
< <% set system_url [parameter::get -package_id [ad_acs_kernel_id] -parameter SystemURL -default ""] %>
< <% set first_names "undefined" %>
< <% set last_name "undefined" %>
< <% set email "undefined" %>
< <% set username "undefined" %>
< <% set current_user_id [auth::require_login] %>
< <% if {"" eq $current_user_id} { set current_user_id 0} %>
< <% db_0or1row user_info "select * from cc_users where user_id=:current_user_id" %>
< <% set publisher_name [parameter::get -package_id [ad_acs_kernel_id] -parameter PublisherName -default ""] %>
< <% set package_versions [db_list package_versions "select v.package_key||':'||v.version_name from (select max(version_id) as version_id, package_key from apm_package_versions group by package_key) m, apm_package_versions v where m.version_id = v.version_id"] %>
< <% set system_id [im_system_id] %>
< <% set hardware_id [im_hardware_id] %>
< <% if {![info exists error_content]} { set error_content "" } %>
< <% if {![info exists error_content_filename]} { set error_content_filename "" } %>
< <% if {![info exists error_type]} { set error_type "default" } %>
< <% if {![info exists top_message]} { set top_message "" } %>
< <% if {![info exists bottom_message]} { set bottom_message "" } %>
< 
< <br>
< <form action="@report_url;noquote@" method=POST>
< <input type=submit name=submit value="Report this Error">
< <br>
< <input type=checkbox name=privacy_statement_p checked>
< I agree with the <a href="https://www.project-open.com/en/legal-note" target="_">privacy statement</a>.
< <br>
< <input type=hidden name=error_url value=@error_url@>
< <input type=hidden name=error_location value=@error_location@>
< <input type=hidden name=system_url value=@system_url@>
< <input type=hidden name=error_first_names value=@first_names;noquote@>
< <input type=hidden name=error_last_name value=@last_name;noquote@>
< <input type=hidden name=error_user_email value=@email;noquote@>
< <input type=hidden name=error_type value=@error_type;noquote@>
< <input type=hidden name=package_versions value="@package_versions;noquote@">
< <input type=hidden name=publisher_name value="@publisher_name;noquote@">
< <input type=hidden name=system_id value=@system_id@>
< <input type=hidden name=hardware_id value=@hardware_id@>
< <input type=hidden name=platform value="<%=$::tcl_platform(platform)%>">
< <input type=hidden name=os value="<%=$::tcl_platform(os)%>">
< <input type=hidden name=os_version value="<%=$::tcl_platform(osVersion)%>">
< 
< 
< <if @message@ not nil>
<   <input type=hidden name=error_message value="@message;noquote@">
< </if>
< <if @stacktrace@ not nil>
<   <input type=hidden name=error_info value="@stacktrace@">
< </if>
< <input type=hidden name=error_content value='@error_content@'>
< <input type=hidden name=error_content_filename value='@error_content_filename@'>
< </form>
< <br>
< 
< <if @bottom_message@ not nil>
< 	@bottom_message;noquote@
< </if>
< 
100a11
> <br>
102c13
< <if @stacktrace@ not nil>
---
>  <a href="@prev_url@">#acs-tcl.Return_prev#</a>
104,108c15,23
<   <p>
<     Here is a detailed dump of what took place at the time of the error, which may assist a programmer in tracking down the problem:
<   </p>
< 
<   <blockquote><pre>@stacktrace@</pre></blockquote>
---
>  <if @bt_instance@ ne "">
>   <if @auto_submit_p@ gt 0>
>     <if @user_id@ gt 0> 
>       <br>
>       <formtemplate id="bug_edit"></formtemplate>
>       <br>
> 	#acs-tcl.Bug_History#
> 	<br><br>
> 	  <formtemplate id="bug_history"></formtemplate>
111,115d25
<   <p>
<     The error has been logged and will be investigated by our system programmers.
<   </p>
< </else>
< 
117d26
< <!-- if not electron -->
119c28,32
< 
---
>     </if>
>   </if>
>  <else>
>  <pre>@stacktrace@</pre>
> </else>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/lib/page-error.tcl openacs-4.5-9-0/packages/acs-tcl/lib/page-error.tcl
12a13,413
> set show_patch_status open
> set user_agent_p 1
> set error_info $stacktrace
> set comment_action 0
> 
> set return_url $prev_url
> 
> if {$user_id eq 0} {
>     set user_name "[_ acs-tcl.Public_User]"
>     set public_userm_email [parameter::get -package_id [ad_acs_kernel_id] -parameter HostAdministrator -default ""]
> } else {
>     db_1row get_user_info { *SQL* }
>     set public_userm_email $user_email
> }
> 
> set send_email_p [parameter::get -package_id [ad_acs_kernel_id] -parameter SendErrorEmailP -default 0]
> set system_name [ad_system_name]
> set subject "[_ acs-tcl.lt_Error_Report_in_ad_sy] ( [_ acs-tcl.File ] $error_file )"
> set found_in_version ""
> set send_to [parameter::get -package_id [ad_acs_kernel_id] -parameter HostAdministrator -default "[ad_system_owner]"]
> 
> set error_desc_email "
>  --------------------------------------------------------<br>
>                    [_ acs-tcl.Error_Report]<br>
>  --------------------------------------------------------<br>
> <strong>[_ acs-tcl.Previus]</strong> [ns_quotehtml $return_url]<br>
> <strong>[_ acs-tcl.Page]</strong> [ns_quotehtml $error_url]<br>
> <strong>[_ acs-tcl.File]</strong> [ns_quotehtml $error_file]<br>
> <strong>[_ acs-tcl.User_Name]</strong> [ns_quotehtml $user_name]<br>
> <strong>[_ acs-tcl.lt_User_Id_of_the_user_t]</strong> [ns_quotehtml $user_id]<br>
> <strong>IP:</strong> [ns_quotehtml [ns_conn peeraddr]]<br>
> <strong>[_ acs-tcl.Browser_of_the_user]</strong> [ns_quotehtml [ns_set get [ns_conn headers] User-Agent]]<br>
> <br>
> -----------------------------<br>
> [_ acs-tcl.Error_details]<br>
> -----------------------------<br>
> <pre>[ns_quotehtml $error_info]</pre>
> <br>
> ------------------------------<br>
> <br>
> <br>
> [_ acs-tcl.lt_NB_This_error_was_sub]"
> 
> if { $bug_number eq "" && $send_email_p} {
>     acs_mail_lite::send -send_immediately \
> 	-to_addr $send_to -from_addr $public_userm_email \
> 	-subject $subject \
> 	-body $error_desc_email
> }
> set bt_instance [parameter::get -package_id [ad_acs_kernel_id] \
> 		     -parameter BugTrackerInstance -default ""]
> 
> if { $bt_instance ne "" } {
>     array set community_info [site_node::get -url "${bt_instance}/[bug_tracker::package_key]"]
>     set bt_package_id $community_info(package_id)
>     set auto_submit_p [parameter::get -parameter AutoSubmitErrorsP -package_id $bt_package_id -default 0]
> } else {
>     set auto_submit_p 0
> }
> 
> if {$auto_submit_p && $user_id > 0} {
>     # Is this project using multiple versions?
>     set versions_p [bug_tracker::versions_p]
>     
>     # Paches enabled for this project?
>     set patches_p [bug_tracker::patches_p]
>     
>     set enabled_action_id [form get_action bug_edit]
>     
>     set exist_bug [db_string search_bug {} -default ""]
>     if { $exist_bug eq ""} {
> 	
> 	#Submit the new Bug into the Bug - Tracker && Into the
> 	# Auto_bugs tabble
> 	set bug_id [db_nextval acs_object_id_seq]
> 	
> 	set keyword_ids [list]
>         foreach {category_id category_name} [bug_tracker::category_types -package_id $bt_package_id] {
> 	    lappend keyword_ids [bug_tracker::get_default_keyword -parent_id $category_id -package_id $bt_package_id]
>         }
> 		
>         bug_tracker::bug::new \
> 	    -bug_id $bug_id \
> 	    -package_id $bt_package_id \
> 	    -component_id [bug_tracker::conn component_id] \
> 	    -found_in_version $found_in_version \
> 	    -summary $subject \
> 	    -description $error_desc_email \
> 	    -desc_format text/html \
> 	    -keyword_ids $keyword_ids \
> 	    -user_id $user_id
> 	
> 	bug_tracker::bugs_exist_p_set_true -package_id $bt_package_id
>         db_dml insert_auto_bug { *SQL* }
>     } else {
> 	
> 	#Comment on the Existing Bug even if the user dont want to add
> 	# commentaries 
> 	# If the bug is closed or fixed we have to reopen the bug
>         array set row [list]
> 	set bug_id $exist_bug
> 	
> 	if {$bug_number eq ""} {
> 	    db_dml increase_reported_times { *SQL* }
> 	}
> 	
> 	# Get the bug data
> 	bug_tracker::bug::get -bug_id $bug_id -array bug -enabled_action_id $enabled_action_id
> 	
>         set case_id [workflow::case::get_id \
> 			 -object_id $bug_id \
> 			 -workflow_short_name [bug_tracker::bug::workflow_short_name]]
>         foreach available_enabled_action_id [workflow::case::get_available_enabled_action_ids -case_id $case_id] {
> 	    workflow::case::enabled_action_get -enabled_action_id $available_enabled_action_id -array enabled_action
> 	    workflow::action::get -action_id $enabled_action(action_id) -array available_action
> 	    if {[string match "*Reopen*" $available_action(pretty_name)]} {
> 		bug_tracker::bug::edit \
> 		    -bug_id $bug_id \
> 		    -enabled_action_id $available_enabled_action_id \
> 		    -description "<strong> [_ acs-tcl.reopened_auto ] </strong>" \
> 		    -desc_format text/html \
> 		    -array row \
> 		    -entry_id $bug(entry_id)
> 	    }
> 	    if {[string match "*Comment*" $available_action(pretty_name)]} {
> 		set comment_action $available_enabled_action_id
> 	    }
>         }
> 	
> 	bug_tracker::bug::edit \
> 	    -bug_id $bug_id \
> 	    -enabled_action_id $comment_action \
> 	    -description $error_desc_email \
> 	    -desc_format text/html \
> 	    -array row \
> 	    -entry_id $bug(entry_id)
>     }
>       
>     set case_id [workflow::case::get_id \
> 		     -object_id $bug_id \
> 		     -workflow_short_name [bug_tracker::bug::workflow_short_name]]
>     set workflow_id [bug_tracker::bug::get_instance_workflow_id -package_id $bt_package_id]
>     
> #    set enabled_action_id [form get_action bug_edit]
>     
>     # Registration required for all actions
>     set action_id ""
>     #if { $enabled_action_id ne "" } {
>     #	workflow::case::enabled_action_get -enabled_action_id $enabled_action_id -array enabled_action
>     #	set action_id $enabled_action(action_id)
>     #    }
>     
>     set times_rep [db_string select_times_reported {} -default 0 ]
>     
>     ad_form -name bug_edit -export {comment_action reopen_action bt_instance bt_package_id user_id bug_package_id} -form {
> 	{bug_number_display:text(inform)
> 	    {label "[bug_tracker::conn Bug] \\\#"}
> 	    {mode display}
> 	}
> 	{component_id:integer(select),optional
> 	    {label "[_ bug-tracker.Component]"}
> 	    {options {[bug_tracker::components_get_options]}}
> 	    {mode display}
> 	}
> 	{summary:text(text)
> 	    {label "[_ bug-tracker.Summary]"}
> 	    {before_html "<strong>"}
> 	    {after_html "</strong>"}
> 	    {mode display}
> 	    {html {size 50}}
> 	}
> 	{pretty_state:text(inform)
> 	    {label "[_ bug-tracker.Status]"}
> 	    {before_html "<strong>"}
> 	    {after_html  "</strong>"}
> 	    {mode display}
> 	}
> 	{resolution:text(select),optional
> 	    {label "[_ bug-tracker.Resolution]"}
> 	    {options {[bug_tracker::resolution_get_options]}}
> 	    {mode display}
> 	}
> 	{previus_url:text(inform)
> 	    {label "[_ acs-tcl.Previus]"}
> 	    {value $prev_url}
> 	}
> 	{err_url:text(inform)
> 	    {label "[_ acs-tcl.Page]"}
> 	    {value $error_url}
> 	}
> 	{err_file:text(inform)
> 	    {label "[_ acs-tcl.File]"}
> 	    {value $error_file}
> 	}
> 	{times_reported:text(inform)
> 	{label "[_ acs-tcl.Times_reported]"}
> 	    {value $times_rep}
> 	}
>     }
>     
>     foreach {category_id category_name} [bug_tracker::category_types] {
> 	ad_form -extend -name bug_edit -form [list \
> 						  [list "${category_id}:integer(select)" \
> 						       [list label $category_name] \
> 						       [list options [bug_tracker::category_get_options -parent_id $category_id]] \
> 						       [list mode display] \
> 						      ] \
> 						 ]
>     }
>    ad_form -extend -name bug_edit -form {
>        {found_in_version:text(select),optional
> 	   {label "[_ bug-tracker.Found_in_Version]"}
> 	   {options {[bug_tracker::version_get_options -include_unknown]}}
> 	   {mode display}
>        }
>    }
>     
>     workflow::case::role::add_assignee_widgets -case_id $case_id -form_name bug_edit
>     
>     ad_form -extend -name bug_edit -form {
> 	{user_agent:text(inform)
> 	    {label "[_ bug-tracker.User_Agent]"}
> 	    {mode display}
> 	}
> 	{fix_for_version:text(select),optional
> 	    {label "[_ bug-tracker.Fix_for_Version]"}
> 	    {options {[bug_tracker::version_get_options -include_undecided]}}
> 	    {mode display}
> 	}
> 	{fixed_in_version:text(select),optional
> 	    {label "[_ bug-tracker.Fixed_in_Version]"}
> 	    {options {[bug_tracker::version_get_options -include_undecided]}}
> 	    {mode display}
>     }
> 	{description:richtext(richtext),optional
> 	    {label "[_ bug-tracker.Description]"}
> 	    {html {cols 60 rows 13}}
> 	}
> 	{return_url:text(hidden)
> 	    {value $return_url}
> 	}
> 	{bug_number:key}
> 	{entry_id:integer(hidden),optional}
>     } -on_submit {
> 
> 	array set row [list]
> 	
> 	set description [element get_value bug_edit description]
> 	set error_desc_html "
>  -------------------------------------------------------- <br>
>                    [_ acs-tcl.Error_Report] <br>
>  -------------------------------------------------------- <br>
> <br><strong>[_ acs-tcl.Previus]</strong> [ns_quotehtml $prev_url]
> <br><strong>[_ acs-tcl.Page]</strong> [ns_quotehtml $error_url]
> <br><strong>[_ acs-tcl.File]</strong> [ns_quotehtml $error_file]
> <br><strong>[_ acs-tcl.User_Name]</strong> [ns_quotehtml $user_name]
> <br><strong>[_ acs-tcl.lt_User_Id_of_the_user_t]</strong> [ns_quotehtml $user_id]
> <br>[_ acs-tcl.Browser_of_the_user]</strong> [ns_quotehtml [ns_set get [ns_conn headers] User-Agent]]
> <br><br><strong>[_ acs-tcl.User_comments]</strong>  
> <br>
> [ns_quotehtml [template::util::richtext::get_property contents $description]]<br>
> <br>"
>  
>   foreach available_enabled_action_id [workflow::case::get_available_enabled_action_ids -case_id $case_id] {
>             workflow::case::enabled_action_get -enabled_action_id $available_enabled_action_id -array enabled_action
>             workflow::action::get -action_id $enabled_action(action_id) -array available_action
>             if {[string match "*Comment*" $available_action(pretty_name)]} {
>                 set comment_action $available_enabled_action_id
>             }
>         }
> 
>    
>      bug_tracker::bug::edit \
>             -bug_id $bug_id \
>             -enabled_action_id $comment_action \
>             -description [template::util::richtext::get_property contents $description] \
>             -desc_format [template::util::richtext::get_property format $description] \
>             -array row \
>             -entry_id [element get_value bug_edit entry_id]
>     
>      ad_returnredirect $return_url
>     ad_script_abort
>    } -edit_request {
>       # ID form complains if -edit_request is missing
> }
> 
> 
> if { ![form is_valid bug_edit] } {
>     
>     # Get the bug data
>     bug_tracker::bug::get -bug_id $bug_id -array bug -enabled_action_id $enabled_action_id
>     
>     
>     # Make list of form fields
>     set element_names {
>         bug_number component_id summary pretty_state resolution
>         found_in_version user_agent fix_for_version fixed_in_version
>         bug_number_display entry_id
>     }
>     
>     # update the element_name list and bug array with category stuff
>     foreach {category_id category_name} [bug_tracker::category_types] {
>         lappend element_names $category_id
>         set bug($category_id) [cr::keyword::item_get_assigned -item_id $bug(bug_id) -parent_id $category_id]
>         if {$bug($category_id) eq "" } {
>             set bug($category_id) [bug_tracker::get_default_keyword -parent_id $category_id]
>         }
>     }
>     # Display value for patches
>     set href [export_vars -base patch-add { { bug_number $bug(bug_number) } { component_id $bug(component_id) } }]
>     set bug(patches_display) [subst {
> 	[bug_tracker::get_patch_links -bug_id $bug(bug_id) -show_patch_status $show_patch_status]
> 	&nbsp; \[ <a href="[ns_quotehtml $href]">[_ bug-tracker.Upload_Patch]</a> \]
>     }]
>     
>     # Hide elements that should be hidden depending on the bug status
>     foreach element $bug(hide_fields) {
>         element set_properties bug_edit $element -widget hidden
>     }
>     
>     if { !$versions_p } {
>         foreach element { found_in_version fix_for_version fixed_in_version } {
>             if { [info exists bug_edit:$element] } {
>                 element set_properties bug_edit $element -widget hidden
>             }
>         }
>     }
>     
>     if { !$patches_p } {
>         foreach element { patches } {
>             if { [info exists bug_edit:$element] } {
>                 element set_properties bug_edit $element -widget hidden
>             }
>         }
>     }
>     
>     # Optionally hide user agent
>     if { !$user_agent_p } {
>         element set_properties bug_edit user_agent -widget hidden
>     }
>     
>     
>     # Set regular element values
>     foreach element $element_names {
> 	
>         # check that the element exists
>         if { [info exists bug_edit:$element] && [info exists bug($element)] } {
>             if {[form is_request bug_edit]
>                 || [string equal [element get_property bug_edit $element mode] "display"] } {
>                 if { [string first "\#" $bug($element)] == 0 } {
>                     element set_value bug_edit $element [lang::util::localize $bug($element)]
>                 } else {
>                     element set_value bug_edit $element $bug($element)
>                 }
>             }
>         }
>     }
>     # Add empty option to resolution code
>     if { $enabled_action_id ne "" } {
>         if {"resolution" ni [workflow::action::get_element -action_id $action_id -element edit_fields]} {
>             element set_properties bug_edit resolution -options [concat {{{} {}}} [element get_property bug_edit resolution options]]
>         }
>     } else {
>         element set_properties bug_edit resolution -widget hidden
>     }
> 
>     # Get values for the role assignment widgets
>     workflow::case::role::set_assignee_values -case_id $case_id -form_name bug_edit
> 
>     # Set values for elements with separate display value
>     foreach element {
>         patches
>     } {
>         # check that the element exists
>         if { [info exists bug_edit:$element] } {
>             element set_properties bug_edit $element -display_value $bug(${element}_display)
>         }
>     }
> 
>     # Set values for description field
>     
>     ad_form -name bug_history -has_submit 1 -form {
> 	{history:text(inform)
> 	    {label "[_ acs-tcl.User_comments]"}
> 	    {value ""}
> 	}
>     }
>     
>     element set_properties bug_history history \
> 	-after_html [workflow::case::get_activity_html -case_id $case_id -action_id $action_id]
> }
> 
> }    
>     
> 



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/lib/page-error.xql openacs-4.5-9-0/packages/acs-tcl/lib/page-error.xql
9a10,47
>   <fullquery name="get_user_info">
>     <querytext>
>       
>       select p.first_names||' '||p.last_name as user_name, pa.email as user_email 
>       from persons p, parties pa
>       where pa.party_id = p.person_id
>       and p.person_id = :user_id
>       
>     </querytext>
>   </fullquery>
>   <fullquery name = "search_bug">
>     <querytext>
>       select bug_id
>       from bt_auto_bugs
>       where error_file =:error_file
>       and package_id = :bug_package_id
>     </querytext>
>   </fullquery>
>   <fullquery name = "insert_auto_bug">
>     <querytext>
>       insert into bt_auto_bugs(bug_id, package_id, error_file)
>       values (:bug_id, :bug_package_id, :error_file)
>     </querytext>
>   </fullquery>
>   <fullquery name = "increase_reported_times">
>     <querytext>
>         update bt_auto_bugs 
> 	set times_reported = times_reported + 1 
> 	where bug_id = :bug_id 
>    </querytext>
>   </fullquery>
>   <fullquery name = "select_times_reported">
>     <querytext>
>       select times_reported 
>       from bt_auto_bugs
>       where bug_id = :bug_id 
>     </querytext>
>   </fullquery>




=======================================================
acs-permissions
=======================================================


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/tcl/acs-permissions-procs.tcl openacs-4.5-9-0/packages/acs-tcl/tcl/acs-permissions-procs.tcl
179,180d178
< 
<     if {$party_id eq ""} { set party_id 0 }





=======================================================
Not sure
=======================================================




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/tcl/defs-procs.tcl openacs-4.5-9-0/packages/acs-tcl/tcl/defs-procs.tcl
371,372d370
<     { show_master_p 1 }
< 
374,376d371
<     Custom implementation of ad_return_complaint which allows for returning err msg only.
<     This allows new program paradigm to improve UX, e.g. HTML overlays (see ]po[ CRM module)
< 
382,383d376
<     @param exception_text HTML chunk to go inside an UL tag with the error messages.
<     @param show_master_p Indicates if master template should be applied
384a378
>     @param exception_text HTML chunk to go inside an UL tag with the error messages.
386d379
<     if { $show_master_p } {
395,397c388
<     } else {
<         ns_return 200 text/html "$exception_text<br/><br/><button onclick='javascript:window.history.back();'>[lang::message::lookup "" acs-tcl.GoBack "Go back"]</button>"
<     }



=======================================================
http-client-procs.tcl: Fix curl issue
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/tcl/http-client-procs.tcl openacs-4.5-9-0/packages/acs-tcl/tcl/http-client-procs.tcl
1093c1093
<     set cmd [list exec curl -s -k1]
---
>     set cmd [list exec curl -s]



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/tcl/security-procs.tcl openacs-4.5-9-0/packages/acs-tcl/tcl/security-procs.tcl
338,342d337
< 
<     ad_unset_cookie -domain $domain -secure f ad_session_id
<     ad_unset_cookie -domain $domain -secure f ad_secure_token
<     ad_unset_cookie -domain $domain -secure f ad_user_login
<     ad_unset_cookie -domain $domain -secure f ad_user_login_secure
<     if {0 && [info exists alt_insecure_location] && $suppress_http_port } {
---
>     if { [info exists alt_insecure_location] && $suppress_http_port } {



=======================================================
util_current_location with tweaks for ]po[
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-tcl/tcl/utilities-procs.tcl openacs-4.5-9-0/packages/acs-tcl/tcl/utilities-procs.tcl
2559,2576d2558
<     # Did somebody set a specific redirection address?
<     # This may be useful with funky HTTPS/redirection settings.
<     set current_location [parameter::get_from_package_key -package_key "intranet-core" -parameter UtilCurrentLocationRedirect -default ""]
<     if {"" != $current_location} {
<         return $current_location
<     }
< 
2587a2570,2577
>     # suppress the configured http port when server is behind a proxy, to keep connection behind proxy
>     set suppress_port [parameter::get -package_id [apm_package_id_from_key acs-tcl] -parameter SuppressHttpPort -default 0]
>     if { $suppress_port && $port eq [ns_config -int "ns/server/[ns_info server]/module/nssock" Port] } {
>         ns_log Debug "util_current_location: suppressing http port $Host_port"
>         set Host_port ""
>         set port ""
>     }
> 
2611,2621d2600
< 
<     # suppress the configured http port when server is behind a proxy, to keep connection behind proxy
<     set suppress_port [parameter::get -package_id [apm_package_id_from_key acs-tcl] -parameter SuppressHttpPort -default 0]
<     if {$suppress_port && $port eq [ns_config -int "ns/server/[ns_info server]/module/nssock" Port] } {
<         ns_log Debug "util_current_location: suppressing http port $Host_port"
<         set port ""
<     }
< 
<     ns_log Debug "util_current_location: proto=$proto, hostname=$hostname, port=$port"
< 





=======================================================
acs-templating/resources
=======================================================


diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/blue.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/blue.adp
3c3
< <table bgcolor=#6699CC cellspacing=0 cellpadding=4 border=0>
---
> <table bgcolor="#6699CC" cellspacing="0" cellpadding="4" border="0">
7c7
< <table bgcolor=#99CCFF cellspacing=0 cellpadding=6 border=0 width="100%">
---
> <table bgcolor="#99CCFF" cellspacing="0" cellpadding="6" border="0" width="100%">
11c11
< <table bgcolor=#99CCFF cellspacing=0 cellpadding=2 border=0 width="100%">
---
> <table bgcolor="#99CCFF" cellspacing="0" cellpadding="2" border="0" width="100%">
16c16
<       <tr><td colspan=2 bgcolor=#eeeeee><b>@elements.section@</b></td></tr>
---
>       <tr><td colspan="2" bgcolor="#eeeeee"><b>@elements.section@</b></td></tr>
46c46
<             <if @elements.label@ nil><td colspan=2>></if>
---
>             <if @elements.label@ nil><td colspan="2">></if>
67c67
< 	      <td bgcolor=#EEEEEE>
---
> 	      <td bgcolor="#EEEEEE">
72c72
<               <if @elements.label@ nil><td nowrap colspan=2></if>
---
>               <if @elements.label@ nil><td nowrap colspan="2"></if>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/confirm-button.tcl openacs-4.5-9-0/packages/acs-templating/resources/forms/confirm-button.tcl
17c17
< if { ![empty_string_p [set __form__ [ns_getform]]] } {
---
> if { [set __form__ [ns_getform]] ne "" } {
23c23
<         if { [string equal [ns_set key $__form__ $__form_counter__] __confirmed_p] } {
---
>         if { [ns_set key $__form__ $__form_counter__] eq "__confirmed_p" } {




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/grid.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/grid.adp
1c1
< <table bgcolor=#6699CC cellspacing=0 cellpadding=4 border=0 width="95%">
---
> <table bgcolor="#6699CC" cellspacing="0" cellpadding="4" border="0" width="95%">
3,4c3,4
<   <td align=left><b>@form_properties.title@</b></td>
<   <td align=right>&nbsp;</td>
---
>   <td align="left"><b>@form_properties.title@</b></td>
>   <td align="right">&nbsp;</td>
8c8
<   <tr><td colspan=2><i>No items</i></td></tr>
---
>   <tr><td colspan="2"><i>No items</i></td></tr>
13c13
< <td colspan=2>
---
> <td colspan="2">
15c15
< <table bgcolor=#99CCFF cellspacing=0 cellpadding=2 border=0 width="100%">
---
> <table bgcolor="#99CCFF" cellspacing="0" cellpadding="2" border="0" width="100%">
18,19c18,19
<     <list name=list_tag>
<       <th align=left>@list_tag:item@</th>
---
>     <list name="list_tag">
>       <th align="left">@list_tag:item@</th>
28,29c28,29
<       <if @elements.row@ odd><tr bgcolor=#ffffff></if>
<       <else><tr bgcolor=#dddddd></else>
---
>       <if @elements.row@ odd><tr bgcolor="#ffffff"></if>
>       <else><tr bgcolor="#dddddd"></else>
36c36
<           <table cellpadding=4 cellspacing=0 border=0>
---
>           <table cellpadding="4" cellspacing="0" border="0">
39c39
<                 <formgroup id=@elements.id@>
---
>                 <formgroup id="@elements.id@">
45c45
<           <noparse><formerror id=@elements.id@><br><font color="red"><b>\@formerror.@elements.id@\@<b></font></formerror></noparse>
---
>           <noparse><formerror id="@elements.id@"><br><font color="red"><b>\@formerror.@elements.id@\@<b></font></formerror></noparse>
50c50
<             <noparse><formwidget id=@elements.id@></noparse>
---
>             <noparse><formwidget id="@elements.id@"></noparse>
54,55c54,55
<               <formwidget id=@elements.id@>
<               <formerror id=@elements.id@><br><font color="red"><b>
---
>               <formwidget id="@elements.id@">
>               <formerror id="@elements.id@"><br><font color="red"><b>
78c78
<       <td align=right colspan=2><input type=submit name=@elements.id@ value="@elements.label@"></td>
---
>       <td align="right" colspan="2"><input type="submit" name="@elements.id@" value="@elements.label@"></td>
90c90
<      <noparse><formwidget id=@elements.id@></noparse>
---
>      <noparse><formwidget id="@elements.id@"></noparse>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/plain.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/plain.adp
32,33c32,33
<             <br />&nbsp;&nbsp;
<             <span style="font-size: 90%"><noparse><formhelp id=@elements.id@></noparse></span><br />
---
>             <br>&nbsp;&nbsp;
>             <span style="font-size: 90%"><noparse><formhelp id=@elements.id@></noparse></span><br>
64c64
< 		<formerror id=@elements.id@><br />
---
> 		<formerror id=@elements.id@><br>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/plainest.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/plainest.adp
3c3
< <table bgcolor=#FFFFFF cellspacing=0 cellpadding=4 border=0>
---
> <table bgcolor="#FFFFFF" cellspacing="0" cellpadding="4" border="0">
7c7
< <table bgcolor=#FFFFFF cellspacing=0 cellpadding=6 border=0 width="100%">
---
> <table bgcolor="#FFFFFF" cellspacing="0" cellpadding="6" border="0" width="100%">
11c11
< <table bgcolor=#FFFFFF cellspacing=0 cellpadding=2 border=0 width="100%">
---
> <table bgcolor="#FFFFFF" cellspacing="0" cellpadding="2" border="0" width="100%">
16c16
<       <tr><td colspan=2 bgcolor=#FFFFFF><b>@elements.section@</b></td></tr>
---
>       <tr><td colspan="2" bgcolor="#FFFFFF"><b>@elements.section@</b></td></tr>
27c27
<         <tr><td align=center colspan=2>
---
>         <tr><td align="center" colspan="2">
39c39
<             <font size=-1><noparse><formhelp id=@elements.id@></noparse></font><br>
---
>             <font size="-1"><noparse><formhelp id=@elements.id@></noparse></font><br>
44c44
<             <if @elements.label@ nil><td colspan=2>></if>
---
>             <if @elements.label@ nil><td colspan="2">></if>
47c47
<             <table cellpadding=4 cellspacing=0 border=0>
---
>             <table cellpadding="4" cellspacing="0" border="0">
61c61
< 	      <td bgcolor=#FFFFFF>
---
> 	      <td bgcolor="#FFFFFF">
66c66
<               <if @elements.label@ nil><td nowrap colspan=2></if>
---
>               <if @elements.label@ nil><td nowrap colspan="2"></if>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/standard.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/standard.adp
1d0
< <table cellspacing="2" cellpadding="2" border="0">
3d1
< 
5c3,4
<       <tr class="form-section"><th colspan="2">@elements.section;noquote@</th></tr>
---
> 		<fieldset id="@elements.form_id;noi18n@:@elements.section;noi18n@" @elements.sec_fieldset;noquote@><!-- section fieldset -->
>         <legend @elements.sec_legend;noquote@><span>@elements.sec_legendtext@</span></legend>
9,10c8,9
<       <if @elements.widget@ eq "hidden">
<         <noparse><formwidget id=@elements.id@></noparse>
---
>       <if @elements.widget;literal@ eq "hidden"> 
> 		<noparse><div><formwidget id="@elements.id@"></div></noparse>
14,17c13,14
< 
<         <if @elements.widget@ eq "submit">
<           <tr class="form-element">
<             <td align="left" colspan="2">
---
> 		<if @elements.widget;literal@ eq "submit"><!-- if form submit button wrap it in the form-button class -->
>   		 <div class="form-button">
19c16
<                 <noparse><formwidget id="@elements.id@"></noparse>
---
>              <noparse><formwidget id="@elements.id@">&nbsp;</noparse>
21,22c18,36
<             </td>
<           </tr>
---
>   		 </div>
>        </if>
>         
> 	   <else> <!-- wrap the form item in the form-item-wrapper class -->
> 	     <div class="form-item-wrapper">
>            <noparse>
> 			 <formerror id="@elements.id@">
> 			   <span class="form-error">
> 				 \@formerror.@elements.id@;noquote\@
> 			   </span> <!-- /form-error -->
> 			 </formerror>
> 		   </noparse>
> 
> 		   <if @elements.widget;literal@ in radio checkbox> 
>              <if @elements.legendtext@ defined>
> 			   <fieldset @elements.fieldset;noi18n@>
>                  <!-- radio button groups and checkbox groups get their own fieldsets -->
> 				 <legend @elements.legend;oni18n@><span>@elements.legendtext@</span></legend>
>              </if>
24,25d37
<         <else>
<           <tr class="form-element">
28a41,47
>                  <if @form_properties.mode;literal@ eq display or @elements.widget;literal@ in radio checkbox date inform>
>                    <!-- no label tag -->
>                  </if>
>                  <else>
> 				   <label for="@elements.id@">
>                  </else>
> 
30c49
<                   <td class="form-label-error">
---
>                    <span class="form-label form-label-error">
33c52
<                   <td class="form-label">
---
>                    <span class="form-label">
35a55
> 
37,38c57,61
<                 <if @form_properties.show_required_p@ true>
<                   <if @elements.optional@ nil and @elements.mode@ ne "display" and @elements.widget@ ne "inform"><span class="form-required-mark">*</span></if>
---
> 
>                <if @form_properties.show_required_p;literal@ true>
>                  <if @elements.optional@ nil and @elements.mode;literal@ ne "display" and @elements.widget;literal@ ne "inform">
>                    <strong class="form-required-mark">(#acs-templating.required#)</strong>
>                  </if>
40c63,65
<                </td>
---
>                </span><!-- form-label -->
>                  <if @form_properties.mode;literal@ eq display or @elements.widget;literal@ in radio checkbox date inform>
>                    <!-- no label tag -->
43,45c68
<               <td class="form-label">
<                 &nbsp;
<               </td>
---
>                                    </label>
48,50d70
<               <noparse>
<                 <if \@formerror.@elements.id@\@ not nil>
<                   <td class="form-widget-error">
53c73,79
<                   <td class="form-widget">
---
>                         <if @form_properties.show_required_p;literal@ true>
>                            <if @elements.optional@ nil and @elements.mode;literal@ ne "display" and @elements.widget;literal@ ne "inform">
> 			     <span class="form-label form-required-mark">
> 			       #acs-templating.required#
> 			     </span>
> 		           </if>
> 		        </if>
55d80
<               </noparse>
57c82
<               <if @elements.widget@ eq radio or @elements.widget@ eq checkbox>
---
> 		     <if @elements.widget;literal@ in radio checkbox>
59c84
<                   <table class="formgroup">
---
>                  <span class="form-widget">
61,63d85
<                       <tr>
<                         <td>\@formgroup.widget;noquote@</td>
<                         <td class="form-widget">
64a87
> 				     \@formgroup.widget;noquote@
66,68c89
<                           </label>
<                         </td>
<                       </tr>
---
> 				   </label><br>
70c91
<                   </table>
---
>                  </span>
73d93
< 
75a96
>                  <span class="form-widget">
76a98
>                  </span>
80,90c102,104
<               <noparse>
<                 <formerror id="@elements.id@">
<                   <div class="form-error">
<                     \@formerror.@elements.id@;noquote\@
<                   </div>
<                 </formerror>
<               </noparse>
< 
<               <if @elements.help_text@ not nil and @elements.mode@ ne "display">
<                 <div class="form-help-text">
<                   <img src="/shared/images/info.gif" width="12" height="9" alt="[i]" title="Help text" border="0">
---
>            <if @elements.help_text@ not nil>
>              <span class="form-help-text">
>                <img src="/shared/images/info.gif" width="12" height="9" alt="Help" title="Help text" style="border:0">
92c106
<                 </div>
---
>              </span> <!-- /form-help-text -->
95,97c109,115
<             </td>
<           </tr>
< 
---
> 		   <if @elements.widget;literal@ in radio checkbox> 
>              <if @elements.legendtext@ defined>
>                <!-- radio button groups and checkbox groups get their own fieldsets -->
> 			   </fieldset>
>              </if>
> 		   </if>
> 		 </div> <!-- form-item-wrapper -->
101,103d118
<   </multiple>
< 
< </table>
105,109c120,121
< <multiple name="elements">
<   <if @form_properties.show_required_p@ true>
<     <if @elements.optional@ nil and @elements.mode@ ne "display" and @elements.widget@ ne "inform" and @elements.widget@ ne "hidden" and @elements.widget@ ne "submit">
<        <span class="form-required-mark">*</span> #acs-templating.required# <% break %>
<     </if>
---
>   <if @elements.section@ not nil>
>     </fieldset> <!-- section fieldset -->
112d123
< 



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/tabbed-dialog.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/tabbed-dialog.adp
1,2c1,2
< <table cellpadding=0 cellspacing=0 border=0 bgcolor=#999999 width=100% height=0>
<   <tr bgcolor=#999999>
---
> <table cellpadding="0" cellspacing="0" border="0" bgcolor="#999999" width="100%" height="0">
>   <tr bgcolor="#999999">
4,5c4,5
<       <table cellpadding=0 cellspacing=0 border=0 bgcolor=#DDDDDD width="100%">
<         <tr align=center>
---
>       <table cellpadding="0" cellspacing="0" border="0" bgcolor="#DDDDDD" width="100%">
>         <tr align="center">
7c7
<             <if @elements.current@ eq 1><td bgcolor=#FFFFFF></if>
---
>             <if @elements.current@ eq 1><td bgcolor="#FFFFFF"></if>
9,12c9,12
<               <td bgcolor=#99CCFF>
<               <table border=0 cellpadding=2 cellspacing=1 width=100% 
<                  bgcolor=#6699cc>
<               <tr align=center bgcolor=#99ccff><td>
---
>               <td bgcolor="#99CCFF">
>               <table border="0" cellpadding="2" cellspacing="1" width="100%" 
>                  bgcolor="#6699cc">
>               <tr align="center" bgcolor="#99ccff"><td>
14c14
<               &nbsp;<font size=-1><noparse><formwidget id=@elements.id@></noparse></font>
---
>               &nbsp;<font size="-1"><noparse><formwidget id="@elements.id@"></noparse></font>




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/resources/forms/wizard.adp openacs-4.5-9-0/packages/acs-templating/resources/forms/wizard.adp
2c2
< <table bgcolor=#6699CC cellspacing=0 cellpadding=4 border=0>
---
> <table bgcolor="#6699CC" cellspacing="0" cellpadding="4" border="0">
6c6
< <table bgcolor=#99CCFF cellspacing=0 cellpadding=6 border=0 width="100%">
---
> <table bgcolor="#99CCFF" cellspacing="0" cellpadding="6" border="0" width="100%">
9c9
< <table bgcolor=#99CCFF cellspacing=0 cellpadding=2 border=0 width="100%">
---
> <table bgcolor="#99CCFF" cellspacing="0" cellpadding="2" border="0" width="100%">
14c14
<       <tr><td colspan=2 bgcolor=#eeeeee><b>@elements.section;noquote@</b></td></tr>
---
>       <tr><td colspan="2" bgcolor="#eeeeee"><b>@elements.section;noquote@</b></td></tr>
30,31c30,31
<           <tr><td colspan=2 bgcolor=#eeeeee><b>@elements.label;noquote@</b></td></tr>
<           <tr><td colspan=2>
---
>           <tr><td colspan="2" bgcolor="#eeeeee"><b>@elements.label;noquote@</b></td></tr>
>           <tr><td colspan="2">
49c49
< 		<table cellpadding=4 cellspacing=0 border=0>
---
> 		<table cellpadding="4" cellspacing="0" border="0">
51c51
< 		<formgroup id=@elements.id@ cols=4>
---
> 		<formgroup id="@elements.id@" cols="4">
55,56c55,56
< 		    <td align=right>&nbsp;\@formgroup.widget;noquote@</td>      
< 		    <td align=left><label for="@elements.form_id@:elements:@elements.id@:\@formgroup.option@">\@formgroup.label@</label></td> 
---
> 		    <td align="right">&nbsp;\@formgroup.widget;noquote@</td>      
> 		    <td align="left"><label for="@elements.form_id@:elements:@elements.id@:\@formgroup.option@">\@formgroup.label@</label></td> 
78,79c78,79
<               </if><else><td bgcolor=#EEEEEE></else>
< 		<noparse><formwidget id=@elements.id;noquote@></noparse>
---
>               </if><else><td bgcolor="#EEEEEE"></else>
> 		<noparse><formwidget id="@elements.id;noquote@"></noparse>
84,85c84,85
< 		<noparse><formwidget id=@elements.id@>
< 		<formerror id=@elements.id@><br><font 
---
> 		<noparse><formwidget id="@elements.id@">
> 		<formerror id="@elements.id@"><br><font 



=======================================================

=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/acs-templating/tcl/date-procs.tcl openacs-4.5-9-0/packages/acs-templating/tcl/date-procs.tcl
1022,1024d1021
<     if { [regexp {([0-9]*)-([0-9]*)-([0-9]*)} $value match _year _month _day] } {
< 	set value "$_year $_month $_day 0 0 0 \{YYYY MONTH DD\}"
<     }




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/calendar/www/view-week-display.tcl openacs-4.5-9-0/packages/calendar/www/view-week-display.tcl
4d3
< #  base_url
28,29d26
< if {![info exists base_url]} { set base_url "" }
< 
219c216
<         "$base_url?[export_vars {{view day} {date ansi_start_date} page_num}]" \
---
>         ?[export_vars {{view day} {date ansi_start_date} page_num}] \
253c250
< set previous_week_url "$base_url?[export_vars {page_num {view week} {date $prev_date_ansi}}]\#calendar"
---
> set previous_week_url ?[export_vars {page_num {view week} {date $prev_date_ansi}}]\#calendar
255,256c252
< set next_week_url "$base_url?[export_vars {page_num {view week} {date $next_date_ansi}}]\#calendar"
< 
---
> set next_week_url ?[export_vars {page_num {view week} {date $next_date_ansi}}]\#calendar
291c287
<     set weekday_url   [export_vars -base "${base_url}view" -url -entire_form {{view day} {date $weekday_date}}]
---
>     set weekday_url   [export_vars -base [ad_conn url] -url -entire_form {{view day} {date $weekday_date}}]



=======================================================
file-storage
=======================================================



diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/file-storage/tcl/file-storage-install-procs.tcl openacs-4.5-9-0/packages/file-storage/tcl/file-storage-install-procs.tcl
55d54
<     catch {
57d55
<     } err_msg




diff -w -r -x CVS -x catalog -I @cvs-id -I @version -I '$Id$Date' packages/file-storage/tcl/file-storage-procs.tcl openacs-4.5-9-0/packages/file-storage/tcl/file-storage-procs.tcl
211d210
<     catch {
212a212
> 
214d213
<     } err_msg
1067,1070c1066
<     # Fraber 2019-03-27: Why changed?
<     # db_exec_plsql update_last_modified ""
<     db_string update1 "select acs_object__update_last_modified(:parent_id, :creation_user, :creation_ip)"
<     db_string update2 "select acs_object__update_last_modified(:item_id, :creation_user, :creation_ip)"
---
>     db_exec_plsql update_last_modified ""
1120,1129d1117
<     # 2019-01-22: Delete permissions and file versions
<     db_dml del_perms "delete from acs_permissions where object_id = :item_id"
<     db_dml del_versions "delete from im_file_versions where version_id in (
< 		select	cr.revision_id
< 		from	cr_revisions cr,
< 			cr_items ci
< 		where	ci.item_id = :item_id and
< 			cr.item_id = ci.item_id
<     )"
<     db_dml del_file "delete from im_files where file_id = :item_id"
1153,1155d1140
< 
<     # delete permissions
<     db_dml del_perms "delete from acs_permissions where object_id = :folder_id"



